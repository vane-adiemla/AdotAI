# -*- coding: utf-8 -*-
"""CÃ³pia de CÃ³pia de agent_pet

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1bk6N-QpCZX_5bJcDDu5udSzHyNanDqCQ
"""

# Commented out IPython magic to ensure Python compatibility.
# %pip -q install google-genai

# Configura a API Key do Google Gemini

import os
from google.colab import userdata
import os
from google.colab import userdata

os.environ["GOOGLE_API_KEY"] = userdata.get('GOOGLE_API_KEY')
from getpass import getpass
import os
os.environ['EMAIL_REMETENTE'] = input("Digite seu e-mail do Gmail: ")
os.environ['SENHA_EMAIL_APP'] = getpass("Digite sua senha de app do Gmail: ")

# Instalar Framework de agentes do Google ################################################
!pip install -q google-adk

from google import genai
from google.adk.agents import Agent
from google.adk.runners import Runner
from google.adk.sessions import InMemorySessionService
from google.adk.tools import google_search  # Importante para permitir buscas
from google.genai import types
from IPython.display import display, Markdown
import textwrap
import warnings
import smtplib
from email.message import EmailMessage
warnings.filterwarnings("ignore")

client = genai.Client()
MODEL_ID = "gemini-2.0-flash"

def call_agent(agent: Agent, message_text: str) -> str:
    session_service = InMemorySessionService()
    session = session_service.create_session(app_name=agent.name, user_id="user1", session_id="session1")
    runner = Runner(agent=agent, app_name=agent.name, session_service=session_service)
    content = types.Content(role="user", parts=[types.Part(text=message_text)])

    final_response = ""
    for event in runner.run(user_id="user1", session_id="session1", new_message=content):
        if event.is_final_response():
            for part in event.content.parts:
                if part.text is not None:
                    final_response += part.text
                    final_response += "\n"
    return final_response


def to_markdown(text):
    text = text.replace('â€¢', '  *')
    return Markdown(textwrap.indent(text, '> ', predicate=lambda _: True))


# --- Agente Coordenador de AdoÃ§Ã£o Animal --- #
#############################################

coordenador_adocao_agent = Agent(
    name="coordenador_adocao_animais",
    model=MODEL_ID,
    instruction="""
    VocÃª Ã© um Agente de IA Coordenador de AdoÃ§Ã£o Animal. Seu papel Ã©:

    - Realizar triagem inicial conversando com o interessado, coletando informaÃ§Ãµes como: tipo de animal desejado, experiÃªncias prÃ©vias, ambiente onde vive, expectativas e compromisso com adoÃ§Ã£o responsÃ¡vel.
    - Responder dÃºvidas frequentes sobre adoÃ§Ã£o, vacinaÃ§Ã£o, castraÃ§Ã£o, requisitos e processo.
    - Ao final da triagem, apresentar o link do formulÃ¡rio de adoÃ§Ã£o: [https://docs.google.com/forms/d/e/1FAIpQLSe7hDZPL59al_Gd1369i6p6Yx736SHhexiCl-NtMB9oYQHyTw/viewform?usp=header]
    - Se solicitado, auxiliar no preenchimento do formulÃ¡rio.
    - Ser sempre acolhedor, claro e incentivar a adoÃ§Ã£o responsÃ¡vel de animais (nÃ£o de crianÃ§as).
    - Use a ferramenta google_search para buscar informaÃ§Ãµes adicionais, se necessÃ¡rio.
    """,
    description="Agente especializado em coordenar o processo de adoÃ§Ã£o de animais.",
    tools=[google_search]
)

planilha_animais_disponiveis = "https://docs.google.com/spreadsheets/d/1U3EBw1YZR0Qt_iqeWZD0rb2kpbogJENbyIe72XXRXws/edit?usp=sharing"
formulario_adocao = "https://docs.google.com/forms/d/e/1FAIpQLSe7hDZPL59al_Gd1369i6p6Yx736SHhexiCl-NtMB9oYQHyTw/viewform?usp=header"

def conversar_com_gemini(mensagem, contexto=[]):
    response = model.generate_content(mensagem, history=contexto)
    return response.text

def enviar_email(destinatario, assunto, corpo):
    """
    Envia um e-mail de texto simples para o destinatÃ¡rio informado.
    Requer uma conta Gmail com senha de app.
    As credenciais devem estar em variÃ¡veis de ambiente:
    - EMAIL_REMETENTE
    - SENHA_EMAIL_APP
    """
    email_remetente = os.environ.get('EMAIL_REMETENTE')
    senha = os.environ.get('SENHA_EMAIL_APP')
    if not email_remetente or not senha:
        print("Erro: defina EMAIL_REMETENTE e SENHA_EMAIL_APP como variÃ¡veis de ambiente.")
        return

    msg = EmailMessage()
    msg['Subject'] = assunto
    msg['From'] = email_remetente
    msg['To'] = destinatario
    msg.set_content(corpo)

    try:
        with smtplib.SMTP_SSL('smtp.gmail.com', 465) as smtp:
            smtp.login(email_remetente, senha)
            smtp.send_message(msg)
        print(f"E-mail enviado para {destinatario}!")
    except Exception as e:
        print("Erro ao enviar e-mail:", e)

def triagem_fluxo():
    print("OlÃ¡! Que bom que vocÃª se interessa pela adoÃ§Ã£o responsÃ¡vel de animais. Vou te fazer algumas perguntas para te conhecer melhor e indicar os melhores pets para vocÃª! ğŸ¾")

    tipo_animal = input("VocÃª tem interesse em adotar um cachorro, um gato, ou estÃ¡ aberto a ambos? ").strip().lower()
    experiencia = input("VocÃª jÃ¡ teve animais antes? Se sim, quais? ").strip()
    residencia = input("VocÃª mora em casa, apartamento ou outro tipo de moradia? ").strip()
    seguranca = input("Sua casa/apto possui telas nas janelas/ quintal? (sim/nÃ£o) ").strip()
    seguranca2 = input("Sua casa/apto permite acesso Ã  rua? (sim/nÃ£o) ").strip()
    pessoas = input("Todos na sua casa concordam com a adoÃ§Ã£o? (sim/nÃ£o) ").strip().lower()
    preferencias = input("Tem preferÃªncia de porte, idade ou temperamento do animal? ").strip()
    tempo = input("Quanto tempo por dia a casa fica vazia? ").strip()
    compromisso = input("VocÃª se compromete a vacinar, castrar e cuidar do animal com responsabilidade? (sim/nÃ£o) ").strip().lower()

    if pessoas != "sim":
        print("\nâ—ï¸ Para adotar um animal, Ã© fundamental que todos na casa estejam de acordo. Converse com sua famÃ­lia/moradores e, quando todos concordarem, ficaremos felizes em te ajudar!")
        print("Se precisar de informaÃ§Ãµes para convencer alguÃ©m ou tirar dÃºvidas sobre adoÃ§Ã£o responsÃ¡vel, posso ajudar. ğŸ˜Š")
        return

    if seguranca != "sim":
        print("\n â—ï¸ Para adotar um animal, Ã© fundamental que ele esteja protegido do acesso Ã  rua com telas e proteÃ§Ã£o nas janelas, sacadas, portas e quintais. Deixe sua casa protegida e entre novamente em contato!")
        print("Se precisar de dicas de empresas que instalam telas de proteÃ§Ã£o, ou dicas de como fazer, posso ajudar. ğŸ˜Š")
        return
    if seguranca2 != "nÃ£o":
        print("\n â—ï¸ Para adotar um animal, Ã© fundamental que ele esteja protegido do acesso Ã  rua, sem nenhuma rota de fuga! Certifique-se de examinar e eliminar todas as possÃ­veis rotas de fuga existentes para que seu prÃ³ximo melhor amigo esteja seguro!")
        return
    if compromisso != "sim":
        print("\A adoÃ§Ã£o responsÃ¡vel inclui o compromisso com vacinaÃ§Ã£o, castraÃ§Ã£o e bem-estar do animal. Quando estiver pronto para assumir esses cuidados, ficaremos felizes em te ajudar na adoÃ§Ã£o!")
        return
    print("\nÃ“timo! Aqui estÃ¡ nossa lista de animais disponÃ­veis:")
    print(planilha_animais_disponiveis)
    print("Se gostar de algum, vocÃª pode preencher o formulÃ¡rio de adoÃ§Ã£o a seguir. Se tiver dÃºvidas, estou aqui para ajudar!")

    print("\nğŸ‘‰ FormulÃ¡rio de adoÃ§Ã£o:", formulario_adocao)
    print("Se quiser, posso te explicar como preencher cada campo.")
    print("Se precisar de mais alguma coisa, digite sua dÃºvida ou 'sair' para encerrar.")

    email = input("\nInforme seu e-mail para receber os prÃ³ximos passos e links importantes: ").strip()
    if email and "@" in email:
        corpo = (
            f"OlÃ¡!\n\n"
            f"ParabÃ©ns! VocÃª foi aprovado(a) na triagem para adoÃ§Ã£o responsÃ¡vel.\n"
            f"Veja aqui os prÃ³ximos passos e links Ãºteis:\n"
            f"- Lista de animais disponÃ­veis: {planilha_animais_disponiveis}\n"
            f"- FormulÃ¡rio de adoÃ§Ã£o: {formulario_adocao}\n\n"
            f"Se tiver dÃºvidas, responda este e-mail ou fale conosco!\n"
            f"AbraÃ§o ğŸ¶ğŸ±"
        )
        enviar_email(
            destinatario=email,
            assunto="ParabÃ©ns! VocÃª foi aprovado para adoÃ§Ã£o responsÃ¡vel ğŸ¾",
            corpo=corpo
        )
        print("VocÃª receberÃ¡ um e-mail com os prÃ³ximos passos!")
    else:
        print("E-mail nÃ£o informado ou invÃ¡lido. Se quiser receber por e-mail depois, Ã© sÃ³ pedir!")
    continuar = input("Deseja realizar outra aÃ§Ã£o ou encerrar? (digite 'sair' para encerrar ou pressione Enter para voltar ao menu): ").strip().lower()
    if continuar == "sair":
        print("Muito obrigado por buscar a adoÃ§Ã£o responsÃ¡vel. Se precisar, estarei aqui! ğŸ’šğŸ¾")
    exit()
contexto = []

while True:
    user_input = input("â“ Como posso ajudar? (Digite 'sair' para encerrar): ").strip().lower()
    if user_input in ["sair", "encerrar", "tchau"]:
        print("Muito obrigado por buscar a adoÃ§Ã£o responsÃ¡vel. Se precisar, estarei aqui! ğŸ’šğŸ¾")
        break

    elif "quero adotar" in user_input or "adotar" in user_input:
        triagem_fluxo()
        continue

    elif "animais disponÃ­veis" in user_input or "ver animais" in user_input:
        print(f"\nğŸ“‹ Veja os animais disponÃ­veis aqui: {planilha_animais_disponiveis}")

    elif any(x in user_input for x in ["castraÃ§Ã£o", "castrado", "vacina", "vacinaÃ§Ã£o", "responsÃ¡vel"]):
        if "castra" in user_input:
            print("\nğŸ“Œ Todos os nossos animais sÃ£o castrados antes da adoÃ§Ã£o. Se precisar, explico mais!")
        elif "vacin" in user_input:
            print("\nğŸ’‰ Todos sÃ£o entregues com vacinaÃ§Ã£o em dia, conforme a idade.")
        elif "responsÃ¡vel" in user_input:
            print("\nğŸ¾ AdoÃ§Ã£o responsÃ¡vel Ã© garantir laÃ§o, cuidado, amor e compromisso com o bem-estar do animal.")
        else:
            print("\nPosso te ajudar com informaÃ§Ãµes sobre vacinaÃ§Ã£o, castraÃ§Ã£o e adoÃ§Ã£o responsÃ¡vel.")

    elif "formulÃ¡rio" in user_input or "formulario" in user_input:
        print("\nğŸ“ VocÃª pode preencher o formulÃ¡rio aqui:")
        print("ğŸ‘‰", formulario_adocao)
        print("Se tiver dÃºvidas sobre o que preencher, Ã© sÃ³ perguntar!")

    else:
        resposta = conversar_com_gemini(user_input, contexto)
        contexto.append({"role": "user", "parts": [user_input]})
        contexto.append({"role": "model", "parts": [resposta]})
        print(resposta)

    print("--------------------------------------------------------------")